# ì‚¬ìš©ì {{ user_id }}ì˜ ì›¹ í˜¸ìŠ¤íŒ… ì„¤ì •
# VM ID: {{ vm_id }}
# ìƒì„± ì‹œê°„: {{ creation_time if creation_time is defined else "ìë™ ìƒì„±" }}

# ì‚¬ìš©ì {{ user_id }}ë²ˆ ì›¹ í˜¸ìŠ¤íŒ… í”„ë¡ì‹œ ì„¤ì •
location /{{ user_id }} {
    # ê²½ë¡œ ì¬ì‘ì„± (/{{ user_id }}/path -> /path)
    rewrite ^/{{ user_id }}(/.*)$ $1 break;
    rewrite ^/{{ user_id }}$ / break;
    
    # VMì˜ ì›¹í¬íŠ¸ë¡œ í”„ë¡ì‹œ
    proxy_pass http://{{ vm_ip }}:{{ web_port }};
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    
    # ì›¹ì†Œì¼“ ì§€ì›
    proxy_http_version 1.1;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection "upgrade";
    
    # íƒ€ì„ì•„ì›ƒ ì„¤ì •
    proxy_connect_timeout {{ proxy_timeout if proxy_timeout is defined else 60 }}s;
    proxy_send_timeout {{ proxy_timeout if proxy_timeout is defined else 60 }}s;
    proxy_read_timeout {{ proxy_timeout if proxy_timeout is defined else 60 }}s;
    
    # ë²„í¼ ì„¤ì •
    proxy_buffering on;
    proxy_buffer_size 128k;
    proxy_buffers 4 256k;
    proxy_busy_buffers_size 256k;
    
    # ì—…ë¡œë“œ í¬ê¸° ì œí•œ
    client_max_body_size {{ max_body_size if max_body_size is defined else "100M" }};
    
    {% if security_headers is not defined or security_headers %}
    # ë³´ì•ˆ í—¤ë”
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-XSS-Protection "1; mode=block" always;
    add_header Referrer-Policy "no-referrer-when-downgrade" always;
    {% endif %}
    
    {% if enable_logging is not defined or enable_logging %}
    # ë¡œê¹… ì„¤ì •
    access_log /var/log/nginx/hosting_{{ user_id }}.access.log;
    error_log /var/log/nginx/hosting_{{ user_id }}.error.log;
    {% endif %}
    
    # ì—ëŸ¬ í˜ì´ì§€ ì²˜ë¦¬
    proxy_intercept_errors on;
    error_page 502 503 504 = @fallback_{{ user_id }};
}

# ì •ì  íŒŒì¼ ìºì‹± (ì‚¬ìš©ìë³„)
location ~ ^/{{ user_id }}/.*\.(jpg|jpeg|png|gif|ico|css|js|woff|woff2|ttf|svg)$ {
    rewrite ^/{{ user_id }}(/.*)$ $1 break;
    proxy_pass http://{{ vm_ip }}:{{ web_port }};
    proxy_set_header Host $host;
    
    # ìºì‹± ì„¤ì •
    expires 1y;
    add_header Cache-Control "public, immutable";
    add_header Vary Accept-Encoding;
}

# ì‚¬ìš©ì {{ user_id }} í´ë°± (ì„œë¹„ìŠ¤ê°€ ì—†ì„ ë•Œ)
location @fallback_{{ user_id }} {
    return 200 '
<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>ì‚¬ìš©ì {{ user_id }} - ì„œë¹„ìŠ¤ ì¤€ë¹„ ì¤‘</title>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            text-align: center; 
            padding: 50px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .container { 
            background: rgba(255, 255, 255, 0.1);
            padding: 40px;
            border-radius: 20px;
            max-width: 500px;
        }
        h1 { color: #f39c12; margin-bottom: 20px; }
        .status { color: #e74c3c; margin: 10px 0; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ”§ ì‚¬ìš©ì {{ user_id }} í˜¸ìŠ¤íŒ…</h1>
        <p class="status">VMì´ ì‹œì‘ ì¤‘ì…ë‹ˆë‹¤...</p>
        <p>ì ì‹œ í›„ ì—¬ê¸°ì— ì›¹ì‚¬ì´íŠ¸ê°€ í‘œì‹œë©ë‹ˆë‹¤.</p>
        <p><a href="/" style="color: #f39c12;">ë©”ì¸ í˜ì´ì§€ë¡œ ëŒì•„ê°€ê¸°</a></p>
    </div>
</body>
</html>';
    add_header Content-Type "text/html; charset=utf-8";
}

# SSH í¬íŠ¸ ì •ë³´ (ì£¼ì„)
# SSH ì ‘ì†: ssh -p {{ ssh_port }} ubuntu@{{ vm_ip if vm_ip != '127.0.0.1' else 'localhost' }} 