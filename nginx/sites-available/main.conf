# ë©”ì¸ ì›¹ í˜¸ìŠ¤íŒ… ì„œë¹„ìŠ¤ ì‚¬ì´íŠ¸ ì„¤ì •
server {
    listen 80 default_server;
    listen [::]:80 default_server;
    server_name localhost _;
    
    # ì•¡ì„¸ìŠ¤ ë¡œê·¸ (ë©”ì¸ ì‚¬ì´íŠ¸ìš©)
    access_log /var/log/nginx/main.access.log main;
    error_log /var/log/nginx/main.error.log;
    
    # Rate limiting ì ìš©
    limit_req zone=general burst=20 nodelay;
    limit_conn perip 50;
    
    # ë³´ì•ˆ ì„¤ì •
    if ($blocked_agent) {
        return 403;
    }
    
    # ë©”ì¸ í˜ì´ì§€ - í†µí•©ëœ ì›¹ í˜¸ìŠ¤íŒ… ì„œë¹„ìŠ¤ ì†Œê°œ
    location = / {
        return 200 '
<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸš€ ì›¹ í˜¸ìŠ¤íŒ… ì„œë¹„ìŠ¤</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .container { 
            text-align: center;
            background: rgba(255, 255, 255, 0.1);
            padding: 40px;
            border-radius: 20px;
            backdrop-filter: blur(10px);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            max-width: 600px;
        }
        h1 { font-size: 2.5rem; margin-bottom: 20px; }
        .subtitle { font-size: 1.2rem; margin-bottom: 30px; opacity: 0.9; }
        .info-box { 
            background: rgba(255, 255, 255, 0.05);
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
            text-align: left;
        }
        .endpoint { 
            font-family: monospace;
            background: rgba(0, 0, 0, 0.2);
            padding: 8px 12px;
            border-radius: 5px;
            margin: 5px 0;
            font-size: 0.9rem;
        }
        .status { color: #2ecc71; font-weight: bold; }
        .highlight { color: #f39c12; font-weight: bold; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸš€ ì›¹ í˜¸ìŠ¤íŒ… ì„œë¹„ìŠ¤</h1>
        <p class="subtitle">ìë™í™”ëœ VM ê¸°ë°˜ ì›¹ í˜¸ìŠ¤íŒ… í”Œë«í¼</p>
        
        <div class="info-box">
            <h3>âœ… ì„œë¹„ìŠ¤ ìƒíƒœ</h3>
            <p class="status">â€¢ Nginx í”„ë¡ì‹œ: ì •ìƒ ë™ì‘</p>
            <p class="status">â€¢ ë°±ì—”ë“œ API: ì—°ê²°ë¨</p>
            <p class="status">â€¢ ë°ì´í„°ë² ì´ìŠ¤: ì—°ê²°ë¨</p>
        </div>
        
        <div class="info-box">
            <h3>ğŸ”— ì‚¬ìš©ì í˜¸ìŠ¤íŒ… ì ‘ì†</h3>
            <p>ì‚¬ìš©ìë³„ ì ‘ì†: <span class="highlight">/{user_id}</span></p>
            <p>ì˜ˆì‹œ: <span class="endpoint">/7</span> (ì‚¬ìš©ì IDê°€ 7ì¸ ê²½ìš°)</p>
        </div>
        
        <div class="info-box">
            <h3>ğŸ“‹ API ì—”ë“œí¬ì¸íŠ¸</h3>
            <div class="endpoint">POST /api/v1/auth/register</div>
            <div class="endpoint">POST /api/v1/auth/login</div>
            <div class="endpoint">POST /api/v1/host</div>
            <div class="endpoint">GET /api/v1/host/my</div>
            <div class="endpoint">DELETE /api/v1/host/my</div>
        </div>
        
        <div class="info-box">
            <h3>ğŸ“š ë¬¸ì„œ ë° ë„êµ¬</h3>
            <p>â€¢ API ë¬¸ì„œ: <a href="/docs" style="color: #f39c12;">/docs</a></p>
            <p>â€¢ í—¬ìŠ¤ì²´í¬: <a href="/health" style="color: #f39c12;">/health</a></p>
        </div>
    </div>
</body>
</html>';
        add_header Content-Type "text/html; charset=utf-8";
        add_header Cache-Control "no-cache";
    }
    
    # API í”„ë¡ì‹œ (ë°±ì—”ë“œ ì„œë²„ë¡œ)
    location /api/ {
        # Rate limiting
        limit_req zone=api burst=10 nodelay;
        
        proxy_pass http://backend_api;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Forwarded-Host $host;
        proxy_set_header X-Forwarded-Port $server_port;
        
        # CORS í—¤ë” (APIìš©)
        add_header Access-Control-Allow-Origin "*" always;
        add_header Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS" always;
        add_header Access-Control-Allow-Headers "Authorization, Content-Type, X-Requested-With" always;
        add_header Access-Control-Allow-Credentials "true" always;
        
        # OPTIONS ìš”ì²­ ì²˜ë¦¬ (CORS preflight)
        if ($request_method = OPTIONS) {
            add_header Access-Control-Allow-Origin "*";
            add_header Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS";
            add_header Access-Control-Allow-Headers "Authorization, Content-Type, X-Requested-With";
            add_header Access-Control-Max-Age 86400;
            return 204;
        }
        
        # íƒ€ì„ì•„ì›ƒ ì„¤ì •
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
    }
    
    # í—¬ìŠ¤ì²´í¬ ì—”ë“œí¬ì¸íŠ¸
    location /health {
        access_log off;
        return 200 '{"status": "healthy", "service": "nginx-proxy", "timestamp": "$time_iso8601"}';
        add_header Content-Type application/json;
    }
    
    # ì •ì  íŒŒì¼ ì²˜ë¦¬
    location ~* \.(css|js|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot|pdf)$ {
        expires 1y;
        add_header Cache-Control "public, immutable";
        add_header X-Served-By "nginx-static";
        access_log off;
    }
    
    # ë³´ì•ˆ: ìˆ¨ê²¨ì§„ íŒŒì¼ ì ‘ê·¼ ì°¨ë‹¨
    location ~ /\. {
        deny all;
        access_log off;
        log_not_found off;
    }
    
    # robots.txt
    location = /robots.txt {
        return 200 "User-agent: *\nDisallow: /api/\nAllow: /\n";
        add_header Content-Type text/plain;
        access_log off;
    }
    
    # favicon.ico
    location = /favicon.ico {
        log_not_found off;
        access_log off;
        return 204;
    }
    
    # 404 í˜ì´ì§€
    error_page 404 /404.html;
    location = /404.html {
        return 404 '
<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>404 - í˜ì´ì§€ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ</title>
    <style>
        body { font-family: Arial, sans-serif; text-align: center; padding: 50px; }
        .error-container { max-width: 400px; margin: 0 auto; }
        h1 { color: #e74c3c; }
    </style>
</head>
<body>
    <div class="error-container">
        <h1>404</h1>
        <p>ìš”ì²­í•˜ì‹  í˜ì´ì§€ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</p>
        <p><a href="/">ë©”ì¸ í˜ì´ì§€ë¡œ ëŒì•„ê°€ê¸°</a></p>
    </div>
</body>
</html>';
        add_header Content-Type "text/html; charset=utf-8";
    }
}

# ì‚¬ìš©ìë³„ í˜¸ìŠ¤íŒ… ì‚¬ì´íŠ¸ ì„¤ì •
# ë™ì ìœ¼ë¡œ ìƒì„±ë˜ëŠ” ì‚¬ìš©ì í˜¸ìŠ¤íŒ…ì€ hosting/ ë””ë ‰í† ë¦¬ì—ì„œ í¬í•¨ë©ë‹ˆë‹¤. 