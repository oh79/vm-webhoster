# 메인 웹 호스팅 서비스 사이트 설정
server {
    listen 80 default_server;
    listen [::]:80 default_server;
    server_name localhost _;
    
    # 액세스 로그 (메인 사이트용)
    access_log /var/log/nginx/main.access.log main;
    error_log /var/log/nginx/main.error.log;
    
    # Rate limiting 적용
    limit_req zone=general burst=20 nodelay;
    limit_conn perip 50;
    
    # 보안 설정
    if ($blocked_agent) {
        return 403;
    }
    
    # 메인 페이지 - 통합된 웹 호스팅 서비스 소개
    location = / {
        return 200 '
<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>🚀 웹 호스팅 서비스</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .container { 
            text-align: center;
            background: rgba(255, 255, 255, 0.1);
            padding: 40px;
            border-radius: 20px;
            backdrop-filter: blur(10px);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            max-width: 600px;
        }
        h1 { font-size: 2.5rem; margin-bottom: 20px; }
        .subtitle { font-size: 1.2rem; margin-bottom: 30px; opacity: 0.9; }
        .info-box { 
            background: rgba(255, 255, 255, 0.05);
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
            text-align: left;
        }
        .endpoint { 
            font-family: monospace;
            background: rgba(0, 0, 0, 0.2);
            padding: 8px 12px;
            border-radius: 5px;
            margin: 5px 0;
            font-size: 0.9rem;
        }
        .status { color: #2ecc71; font-weight: bold; }
        .highlight { color: #f39c12; font-weight: bold; }
    </style>
</head>
<body>
    <div class="container">
        <h1>🚀 웹 호스팅 서비스</h1>
        <p class="subtitle">자동화된 VM 기반 웹 호스팅 플랫폼</p>
        
        <div class="info-box">
            <h3>✅ 서비스 상태</h3>
            <p class="status">• Nginx 프록시: 정상 동작</p>
            <p class="status">• 백엔드 API: 연결됨</p>
            <p class="status">• 데이터베이스: 연결됨</p>
        </div>
        
        <div class="info-box">
            <h3>🔗 사용자 호스팅 접속</h3>
            <p>사용자별 접속: <span class="highlight">/{user_id}</span></p>
            <p>예시: <span class="endpoint">/7</span> (사용자 ID가 7인 경우)</p>
        </div>
        
        <div class="info-box">
            <h3>📋 API 엔드포인트</h3>
            <div class="endpoint">POST /api/v1/auth/register</div>
            <div class="endpoint">POST /api/v1/auth/login</div>
            <div class="endpoint">POST /api/v1/host</div>
            <div class="endpoint">GET /api/v1/host/my</div>
            <div class="endpoint">DELETE /api/v1/host/my</div>
        </div>
        
        <div class="info-box">
            <h3>📚 문서 및 도구</h3>
            <p>• API 문서: <a href="/docs" style="color: #f39c12;">/docs</a></p>
            <p>• 헬스체크: <a href="/health" style="color: #f39c12;">/health</a></p>
        </div>
    </div>
</body>
</html>';
        add_header Content-Type "text/html; charset=utf-8";
        add_header Cache-Control "no-cache";
    }
    
    # API 프록시 (백엔드 서버로)
    location /api/ {
        # Rate limiting
        limit_req zone=api burst=10 nodelay;
        
        proxy_pass http://backend_api;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Forwarded-Host $host;
        proxy_set_header X-Forwarded-Port $server_port;
        
        # CORS 헤더 (API용)
        add_header Access-Control-Allow-Origin "*" always;
        add_header Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS" always;
        add_header Access-Control-Allow-Headers "Authorization, Content-Type, X-Requested-With" always;
        add_header Access-Control-Allow-Credentials "true" always;
        
        # OPTIONS 요청 처리 (CORS preflight)
        if ($request_method = OPTIONS) {
            add_header Access-Control-Allow-Origin "*";
            add_header Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS";
            add_header Access-Control-Allow-Headers "Authorization, Content-Type, X-Requested-With";
            add_header Access-Control-Max-Age 86400;
            return 204;
        }
        
        # 타임아웃 설정
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
    }
    
    # 헬스체크 엔드포인트
    location /health {
        access_log off;
        return 200 '{"status": "healthy", "service": "nginx-proxy", "timestamp": "$time_iso8601"}';
        add_header Content-Type application/json;
    }
    
    # 정적 파일 처리
    location ~* \.(css|js|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot|pdf)$ {
        expires 1y;
        add_header Cache-Control "public, immutable";
        add_header X-Served-By "nginx-static";
        access_log off;
    }
    
    # 보안: 숨겨진 파일 접근 차단
    location ~ /\. {
        deny all;
        access_log off;
        log_not_found off;
    }
    
    # robots.txt
    location = /robots.txt {
        return 200 "User-agent: *\nDisallow: /api/\nAllow: /\n";
        add_header Content-Type text/plain;
        access_log off;
    }
    
    # favicon.ico
    location = /favicon.ico {
        log_not_found off;
        access_log off;
        return 204;
    }
    
    # 404 페이지
    error_page 404 /404.html;
    location = /404.html {
        return 404 '
<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>404 - 페이지를 찾을 수 없음</title>
    <style>
        body { font-family: Arial, sans-serif; text-align: center; padding: 50px; }
        .error-container { max-width: 400px; margin: 0 auto; }
        h1 { color: #e74c3c; }
    </style>
</head>
<body>
    <div class="error-container">
        <h1>404</h1>
        <p>요청하신 페이지를 찾을 수 없습니다.</p>
        <p><a href="/">메인 페이지로 돌아가기</a></p>
    </div>
</body>
</html>';
        add_header Content-Type "text/html; charset=utf-8";
    }
}

# 사용자별 호스팅 사이트 설정
# 동적으로 생성되는 사용자 호스팅은 hosting/ 디렉토리에서 포함됩니다. 